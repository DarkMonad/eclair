/*
 * Copyright 2018 ACINQ SAS
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package fr.acinq.eclair.blockchain.electrum.sqlite

import java.sql.DriverManager

import fr.acinq.bitcoin.{BinaryData, Transaction}
import fr.acinq.eclair.db.ChannelStateSpec
import fr.acinq.eclair.db.sqlite.{SqliteChannelsDb, SqlitePendingRelayDb}
import org.junit.runner.RunWith
import org.scalatest.FunSuite
import org.scalatest.junit.JUnitRunner
import org.sqlite.SQLiteException

@RunWith(classOf[JUnitRunner])
class SqliteTxCacheSpec extends FunSuite {

  def inmem = DriverManager.getConnection("jdbc:sqlite::memory:")

  test("add/remove/list channels") {
    val sqlite = inmem
    val db = new SqliteTxCache(sqlite)

    val transactions = Seq(
      Transaction.read("0100000003d7c80991cd49958c272caaf27c73cdc79711bf7f675b4f60e21cd2d006d3da490a000000fdfe0000483045022100add8ba2d900ba68502058d54d66fb9ce2340444b865bf21906618ca543b95ca402202a5625f376348da8f24228b11c72de7811506874dfdfb92e6e6f0294dd03b251014830450221009ffd829a27cde1ea72189ca1269d0823c5ee29893ed75181d3014a40921d48550220465ba681856b311a62703b1df8e41a11a3bde5afb0f376df085e6b65abad9ec5014c6952210328b06206ecafb1019a34e4ef4022a4391e8353e08b339ace297184e66833cc5c210393414bf524d32dedc3c58c0605cc28603a0c44c40f47096933eb8223b4112b982103bb0c58a68011acd702ed4da5b4e92543fd21ea16bbf9b6e8d9bd5f454a31245453aeffffffff3792cad186fb4b1f26f8bdf6abeb20f929cb1ad6600023526d12f567171a8b14ed010000fc00473044022038597213b94903205dc613022658ac8c98d1b1fd99c95d18cd3ec771ac44b0b4022025e60644d65da6e0c9273e9356abfdc661a2c17e99eeca3d21d07ca20e3be25b0147304402201af9d6ae4853172d37701a794b03e6cc6c5f643a187f690f4eed877493e5f41902206681a13eeba561affc7c1d3767f30bc9518eadf0ddaf33cbf05e9a95f7bed639014c69522102e96057cfe19e244c86d0020527f59993fedba3bec89a35bd5c8f110b4de7d54d21022cafc8696feee82599787b12a232021b02a5ce1257f606c69b0e136ff29b57672102c3ceaf9bc8c2ada9a5348595716008e4fbf4a89dc6375edf5189effe86f6d1bf53aeffffffff3792cad186fb4b1f26f8bdf6abeb20f929cb1ad6600023526d12f567171a8b14f0010000fc0047304402203a6d9cf139ea12c3b2be5db07df80ff09d4e75064a3216da860f9398de875806022039a680c4555e7db3dc0587a79f2c94862870fac6802100d7cfea88498877a94a0147304402205fdd077e6b4c6d184a68bc3a2c29d3de1d5c9244940fad01e97ce9e4df500c69022049092618dfd80f1643e27b98aeb0ade28ce2f97453f79b0a3def63c9bfc14712014c695221034c77b997a26afcd96060aa0ae69711db14e3994ed614e581efe843596c59932d210346244e386d56d61e093eadb221680c684c931be72c0cc3e781556c15e5f8b7e52103bbd9d119301961152c8d60563b058505070e3a9d58f1a5b4998ad4637bfe926953aeffffffff01ba8c90000000000017a9149905c5ef89d6598bbdeaf449a2e54dfd0e47827e8700000000"),
      Transaction.read("01000000036e89d76b1e417097e670c7bf37dbe56afcb82cc4988e081e7ae283ff978b83d80d000000fdfe0000483045022100bc9ef201e48a59e39c2381d6029565da158fc3b5335895fca2c7508238fbc09102207e6a77ba6eb7128e99421e8bc0266d677df60d5a8ac60075633911e96d6dae7a01483045022100ee81e80609f90ea77144f430ddf9a0b89eeb649de253ee3683bcc3bfa81731cb022027f34db9b31012f7ececbcf0b34ffc1ab4ebaa5d8af50ff7369d206345e43935014c69522103d80e1a02d09ddcbf199926fa02b209f1dbfcbdfd11258bec0c36adc68ba953fd21026621c8239542d1d4efa90cd6cd9f04c4da95e09304a00db05e3d3c52bca2b8902102ceba5696f99ece4e1e5b9499d61632f4d8564d6726ac6380dfdcd9cde117da8b53aeffffffff51d5e9873d7532da229643c1d4fc2ad63452e934d917e3a4d73535f100f1671500000000fc0047304402204a46a1e2d688228d5f9a0988cee6d2f6ee74cf2f8550364baf170d2c27d5b0bd022025a21d6a47c3a3963e0b6422faf1551fce05fe70070ddef4532c7294f335845e0147304402202c575229c7e3e32c115fe63d446cf4219c06105b22a58822bd400477cb418b0c0220424b05117e45b6422bb2f74f34def6532d28dd75ae979f1a5189b67bbaec8a24014c6952210393744799262152a5986989a0355af4fe3461ca0308f9534e21e05327734e7816210272b1fe80ac427aee095b85bf3c926148ba71971cbc0aae6ff25f49b123694b1f2103d65b8ffd9ae0df386aac5a72e40901b15bebab2a7a068abf1dc5d7fb3311e1b153aeffffffff9665fb31d29bf7dadcd35fc9333a61c1024f13efcdbdc7afedb0e8648d61731501000000fc0047304402202793cdf1de434568964d9aa5d2a2032894391c1544173c8c779d24b0d0a7307602203d627d8efcae4e9c6bcf3ee98024a330befdd36ee9b1649ab2bd4628eea3f78f0147304402201d31632db834306af7f5d9737d49d2f16a167b76e3fb4c39896f373cb9ad16520220401f086aad7f5d91b8c846635e343540c061090b96b480b40ba936800ffd20c8014c6952210320667ecc5b08d7b5b2ad0a13baa6e823d199f01de9a6f8b09389b53c59ce9fb02102cd3d25a370b9559f6b8b3aab90cf27eb60e61427c0e884928fb646a87dba4e93210206ab5da7a2b6acd0c98f6de029d4fff0f9a4a1b76808e96953a80c653083e98153aeffffffff015deef1000000000017a9141d64677ae1fb294e30fd310eff8a034b4b5e48ad8700000000"),
      Transaction.read("010000000c51fa8f22e6734ef847186b1a93d8185b7a23c5eaf9f901b6fe39574d2c7e6531000000006b483045022100fff5db35bb83de37cfa61b21581eee5c87b0f65e839bb253628f76932e1f939b0220012b2896307fc7616755204b2b534c22f2b4e1cc25faae734a2c2a646bf90e0701210392244a748c22429b668bcc3e4fa120bb6b0cad7f26c74a2b24e7da22fcbc2bf5fefffffff6defc3ee2102f5168bd7450feb0f0d8bcdff6fbae4f2f8bc5bcd2749e0c9ba7000000006b483045022100d201607b3d5b1d7ed876e0f7f02aad2a1ca92fcfe00b7f78291dee0a06b0fccb022069909b588335b8f6cc6fa0531a1c63d149c24ace11829078fe87e310f8ac99210121038b3224f7b8c875b374b07d00ef1a9607c2cfa915c027751d994e705d832374b7feffffff5fd21aaa14d30ed9c6b3d2632b2f2b6e3d01c44ea6b3a3cf1b61fdb14b021b6e010000006a4730440220528594da4167613b6b539e93472733167670d5ccd58bbae82b6f2727bc0214e1022031b49bfd1194289759333950a6f988e1bf83447d288a37df8f06fe1e5b0415c8012103477752de32740747424321df65589156b9e9bbad1ec47233858cdcbe564522c2feffffffc9559229bc415e4e362eeea9aa290146a20b490f0d84e8de7f96583c1248f331010000006b4830450221008c8c4fbe9f380f415b4c1c86926dec8be213ff1447cdf36bcda5002ebb66ebcc02207cb9e24193e0e96b6a244dc3dffa064f14c8144a9bccb95fc9b03afc3d18d703012102f9cab1d8e0246c53dc76c9b35b9fc238cd1fb1557d8d9cc2c90941f2517133eafeffffff3af3abad001c6936ed45e2861ac97e4bca8470551813f81d6524d547e721be44000000006a47304402201ef11950eda596ed1bf3fdc5114fca861f05c804967cec2d3eea5c6c86dbd83f02201ad67c5c0f6437773e6a438b6d0069820fa77b7eed0beb08a38b6520bf89be42012102136ee1ba6eba4f1774563627979463790484db0d1b670afd7d30f88f8e262dfcfeffffff3f358ef4947061ecae2a7ddeb8c7b890291a0297d7164d8156e72d3683dc6c00000000006a47304402200e29e04545befce38d3c2a3cda47bedff98ff5140ef557f268755f9e5f4ea8cf02206bc37acba6455a855f78f31c22c85a83c9fc31a3a91a03fb621a0babf7c1c775012102930dbd6267cf9cdc82cc2ad49607985b202c933816f5b88d365dcd56b5ad2a9afeffffff2300f29cd2412d57d26e6950494485bfa81c8a1a55868d2046389e02a3fc9edf010000006a47304402203c62370dc2b8996cc1df14c9abf8c35a05d2537b867b69204dcf1474dfc2406502205f17e74d2acfff6cda30eee1958f08e087ed16f58cf087ed8431cc183ff77d8e0121028ae29a1b88a95c44f5ba4dfe986eced4bf1f3176a440ceaf44ce877597608050fefffffffc01c989cb9da0323ab2e3e22234ee0d904f267c819204900b31958c167af769010000006b483045022100e6710cee8299a349121603f1cdc87260e7f9cfa545200ce9a33eab027f53674f022043e1d970146f7c9bd3d98abd1b058e8ae765127ca9b7cefafa837c0c7e3bf00e0121031a5416db55c69a466e8d67984debc4ca6d90feffa415c379be3ec2a3586114b2feffffff525cd0ecc9c7106b920914d2b319c6577b810d80b5836ef1aa7a3c0abb6d1344000000006b483045022100b1962ee39d2f36f7904eff860fbd1c44fa1255b33cace1368143b627ac7df05b02206490851dc4bed4d85579da1f4b8024453f72c818d881d45f4c0c176c9cec2ec90121034a48c7c39e6948fea6534a26f30b5c8eb082ebd73e71f417fcc6b33779df723efeffffff4c63320b02443dfa589593d5d866dade745627a57b19f84c8612a850b607c4bb000000006b4830450221009a8cbaf949833085aeaa55fe552ac636b435d9ca825a8cd25e09032788634772022064465f40412968062d3a3ca7170fcb3b27663c1b0da5dec36123acfe2e75bba301210372dfdec5d3de7977f8588849d37ad5dab47253dd0087b09729202c5a25985786feffffff57901617dbc67d4570ea9f80dbccdee02e36b0a6d41d029898f0b29fc6c0e7e2010000006b483045022100fbab68e70b67dfe9ba63572a325724b053f9fb3d212bff0f040cdfdce714f9d1022070e903e4a038d97b1bc478ff2f889029eb3d1b727d705e58eb09e147f0f03151012103e5d1e8b6afb6c93225353fa82021fb7f8375bc33cdcd8d33cb7ece9d2ac1ee32feffffff5284377be42634d982ad65bf670ef098f98fb3737bfe115f1aaf5e7802e1e97f010000006b48304502210093d75ca6914630b91ecf952c0e322f25e89c6e7b16e08b7f144e2684b3c6ac1702204a40502135edeac4397ba6eb555c910234460f32da6a8d58ebcf59a94f14fff60121033cd2f9aa1c6a87f549944269a1338c7a86578094566877dfd162ec373241fc99feffffff02f0fcf300000000001976a914d835a2e422b715a1194f57daa7a92f768e04e5ad88acf2420f00000000001976a91426f1b54c8c48849f248f01adf2015087697bc62a88ac6c1a0600"),
      Transaction.read("01000000064020ce35f379e204ccf7f5cfef4e25c168cf3d25db59966d72287846e3368efa000000006a47304402200349493109f88956b8e29edaa388c659e597300c3c3c1fead0d62b25c195d68e02207cc36ed360f36d434cf175ee593b98326fe1d07c112303ec9fc6020c2bd0896c012102b4b4a1887691b7bc29691c0ca5537d519eec98874c62ed350762e93bedb18895ffffffff18908348f7981e6ea4f3f7c2767505b715eba4979d9fbbdcda493c1724d08ac3000000006a4730440220429136924878734dcfa3cbc57bc4a9d4f77efedef91da0866c36d1c75b378b4502203813d40fc274ed97a8af5e7eaa16252187bdc71b0854ddf159f23fa9c5c8552401210334921bbcc83269e57219adb007501c436206db3ab0dd25f7eb3cf44e9664b144ffffffffc0d14bdad14dd1b305608bf337c48f2a35e2e4454917422de6d88727f98e4629000000006a473044022030c8cd286548bf39d43b5f6fe6209bc75e0008532c085b4f211c5aa908d865750220751b6b2d823989c14b314e73ee243784165e02204081b646d1c59a4ba2432386012102d229c1d961da61d6862f162bd803361eb38dcd3fb64faa441ab7535b60174f09ffffffff730fae7f56cde3390716b28384fbec38fa53c5d3da020fc7b0b26c169b4475c3000000006a47304402202bc72f84218dce781828d4012a2720c4f7383fc174ed672ecc09b3f8b16cc7080220466151876e6f11d7b7f4997b1f5ef6eacf2517653e69b329ed4b7bae95ce907a0121025c5e7feb7840e2553d863059eaf462847b9d288f2c568ac37f7f82837ee6c5d7ffffffff5912ff1921d9fbc735c1d9fa62426b117452b7803eee3528eb14a41ab09a6c5f000000006a473044022054ca764ce831606a7a7058995ed0aa1fe1212e555c0130eaea574d491b94527c0220426bebe07d41a8f84c45aafb9ccd309b8c2f3e1e1546430af92aaabf816a4a8d0121034071f0673b7ef918854f59ef9ba9ba1e7ead1b84901990bb8e7267e3252c6612ffffffffa2775b2990a829ca1cb128199ebaa3abf0307600e3957aa2b2fe314b9558e0ef000000006a4730440220757ffd58352952e59b699221475b27492e8ba34705ed281a90b8fdc978cfc335022077e2d1fcb4ef873bd7f51a77d38100c79bcf0a0739032d5653a05c2ea4d496d7012103399836d075eb2590c151564df1e6cb5fdc835911e7bbaa5ff79705c9a1132e87ffffffff01b6ef0d01000000001976a9140db0062b645a037421f01c75f5c202f843fb14cb88ac00000000"),
      Transaction.read("010000000659a64c37117ac788b17384a1f4be29e34d763503af84b7150f47eb2292ad8712000000006a473044022062b66a36dd6b171fc5e61737d1bbd0d07a34999bf7e6267b969223fb7772b21a022060337067cc28bbb4946a40304898e2ee3ea612dc80bc5381e6c6c3c41838fbce012103e650631ccc25ac107433e4f42b8838459bd35d90d2535051864decc2333529b9ffffffff7a7dbec93750053ef6d89cc5e7922ada50df206a0a9dc64caa6c5abc3a1df0ea000000006a47304402205882b93ea9ac9cb11e2b8479d771756708321f822b5f62a12a247cc9e762859e0220718adf6447d74af59fb58833250b571ad6bcf6d1a3843d6050e280f4a7812e3e01210386cf336bda02607dfab16afcaed15811e74961fecd71a0ef0183606eb6d8b162ffffffff63e76e683121ec6bc3ffa6cfc819fc9e216b598cb6e499479407c4fe15e5f9f7000000006a47304402203422e48ca472af468081722b4bec563aad67e0fca3cf47222cf226f2cfe72a1b02205d491b9b0d4f403763a390310c56037e6961ab8456aadaf7182b291c882b03d901210308d8aaffb42725c1fa3e1a4a7b7e82db6b47380f2a9fcfca57a3567f2386ea77ffffffff5ede5cdc836f96de8b6bd442ffd3720c8756539c2620588ad6cd87214ec19962010000006a4730440220542aaf03ea70ff238cf1b00e8101368afc766273c6ec21f81d4526c4ff0ad13402204f435b05d7ebd85b9a53db0b98b6e16f382018ecdf16015a930481df7f781694012103dcdbec9b9ea475e6a75526597cfb02fa8a318fc2241a9b95ece2ee322ac18eeeffffffff154e58a550db9189597a5ffb23ecc8baab0feff8e2aa3753efdeb3ad690365a7000000006a4730440220646bcbf1689218b0116f2d212acb88db24dd43f4216cca82532d036031534d1b02203c336ecec680d5b207ea24fa2541b63a43ed4ccb25f518a9e5f5d098bdbfbb4f012102ce9156969ade3451408bfbecc2b1368c0a5094f6541a49d2a1082549a5d3d901ffffffffa1af15a99a047e53bd47d952cbf387093ad3cdcd9a265e4f1dedf740ced192c7000000006a47304402206dafe7d85903d1008d6d88e9d119c52ff90c7a1d09fe6d4cd4d119d201e28e950220548ccf3ce3bc2bbc23467f1c0a3663290cc6451d99c66b30b6c211cbc7f06dee0121036bf0cf8d15b1af9a0aa72b69a386804c5eeec7ea6c67084c318058effc3a84dcffffffff01af60f506000000001976a9140db0062b645a037421f01c75f5c202f843fb14cb88ac00000000")
    )

    assert(db.getAll == Seq())

    db.put(transactions(0))
    assert(db.getAll == Seq(transactions(0)))
    assert(db.get(transactions(0).txid) == Some(transactions(0)))
    assert(db.delete(transactions(0).txid) == 1)
    assert(db.get(transactions(0).txid) == None)
  }
}
